<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</title>

<style>
:root{
--main:#1976d2;
--success:#2e7d32;
--warning:#ef6c00;
--danger:#c62828;
--bg:#f4f6f9;
--card:#ffffff;
--unpaid:#fdecea;
}
body{font-family:Arial;background:var(--bg);margin:0;padding:15px}
h2{text-align:center;color:var(--main)}
.card{background:var(--card);padding:15px;border-radius:10px;margin-bottom:15px}
input,select,button{width:100%;padding:10px;margin:5px 0}
button{border:none;border-radius:6px;color:#fff;cursor:pointer}
.main{background:var(--main)}
.success{background:var(--success)}
.warning{background:var(--warning)}
.danger{background:var(--danger)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
th{background:var(--main);color:#fff}
.row-ok{background:#e8f5e9}
.row-warn{background:#fff3e0}
.row-expired{background:#fdecea}
.row-unpaid{background:var(--unpaid)}
.days-ok{background:#c8e6c9;padding:4px 8px;border-radius:12px}
.days-warn{background:#ffe0b2;padding:4px 8px;border-radius:12px}
.days-expired{background:#ffcdd2;padding:4px 8px;border-radius:12px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox" class="card" style="max-width:350px;margin:100px auto;text-align:center">
<h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
<input id="loginEmail" type="email" placeholder="Email">
<input id="loginPass" type="password" placeholder="Mot de passe">
<button class="main" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- APP -->
<div id="app" style="display:none">

<h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h2>
<button class="danger" onclick="logout()">Logout</button>

<div class="card">
<input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†">
<input id="phone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ">
<select id="product">
<option value="">Ø§Ù„Ø®Ø¯Ù…Ø©</option>
<option>Netflix</option>
<option>IPTV</option>
<option>Shahid</option>
</select>
<input id="days" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…">
<button class="main" onclick="addSub()">â• Ø¥Ø¶Ø§ÙØ©</button>
</div>

<div class="card">
<table>
<thead>
<tr>
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø§Ù„Ù‡Ø§ØªÙ</th>
<th>Ø§Ù„Ø®Ø¯Ù…Ø©</th>
<th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
<th>Ø§Ù„Ø£ÙŠØ§Ù…</th>
<th>WhatsApp</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

const firebaseConfig = {
 apiKey: "AIzaSyBTE_aaLCtUHt5MZq95k7uYCQ1vl7jTQvw",
 authDomain: "systeme-des-abonnements-6a98c.firebaseapp.com",
 projectId: "systeme-des-abonnements-6a98c"
};

const appFirebase = initializeApp(firebaseConfig);
const db = getFirestore(appFirebase);
const auth = getAuth(appFirebase);

const $ = id => document.getElementById(id);
let subs = [];

/* LOGIN */
async function login(){
 try{
  await signInWithEmailAndPassword(auth,$("loginEmail").value,$("loginPass").value);
 }catch(e){
  alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„");
 }
}
async function logout(){ await signOut(auth); }

onAuthStateChanged(auth,user=>{
 $("loginBox").style.display = user?"none":"block";
 $("app").style.display = user?"block":"none";
 if(user) loadSubs();
});

/* DAYS CALC â€” Ø«Ø§Ø¨Øª 100% */
function calcDays(endISO){
 const now = new Date();
 const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
 const end = new Date(endISO);
 const endDay = new Date(end.getFullYear(), end.getMonth(), end.getDate());
 return Math.round((endDay - today) / 86400000);
}

/* LOAD */
async function loadSubs(){
 subs=[];
 const snap = await getDocs(collection(db,"subs"));
 snap.forEach(d=>subs.push(d.data()));
 render();
}

/* ADD */
async function addSub(){
 let d = parseInt($("days").value,10);
 if(!d || !$("name").value || !$("phone").value || !$("product").value) return;

 let end = new Date();
 end.setHours(0,0,0,0);
 end.setDate(end.getDate() + d);

 await addDoc(collection(db,"subs"),{
  name:$("name").value,
  phone:$("phone").value,
  product:$("product").value,
  end:end.toISOString()
 });
 loadSubs();
 $("name").value=$("phone").value=$("days").value="";
 $("product").value="";
}

/* WHATSAPP */
function sendWhatsApp(phone,name,product,end,days){
 phone=phone.replace(/\s|\+/g,"");
 let msg=`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name} ğŸ‘‹
Ø§Ø´ØªØ±Ø§Ùƒ ${product}
ğŸ“… ÙŠÙ†ØªÙ‡ÙŠ: ${end}
â³ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${days} ÙŠÙˆÙ…
â€” Yazid STORE`;
 window.open("https://wa.me/"+phone+"?text="+encodeURIComponent(msg),"_blank");
}

/* RENDER */
function render(){
 $("list").innerHTML="";
 subs.forEach(s=>{
  let diff=calcDays(s.end);
  let cls = diff<0?"days-expired":diff<=3?"days-warn":"days-ok";
  let tr=document.createElement("tr");
  tr.innerHTML=`
  <td>${s.name}</td>
  <td>${s.phone}</td>
  <td>${s.product}</td>
  <td>${new Date(s.end).toLocaleDateString()}</td>
  <td><span class="${cls}">${diff}</span></td>
  <td><button class="success" onclick="sendWhatsApp('${s.phone}','${s.name}','${s.product}','${new Date(s.end).toLocaleDateString()}',${diff})">ğŸ’¬</button></td>
  `;
  $("list").appendChild(tr);
 });
}

Object.assign(window,{login,logout,addSub,sendWhatsApp});
</script>

</body>
</html>
