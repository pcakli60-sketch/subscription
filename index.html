<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</title>

<style>
:root{
 --main:#1976d2;
 --bg:#f4f6f9;
 --card:#fff;
 --warn:#fff3cd;
 --danger:#f8d7da;
 --unpaid:#fdecea;
}
body{font-family:Arial;background:var(--bg);margin:0;padding:15px}
h2{text-align:center;color:var(--main)}
.card{background:var(--card);padding:15px;border-radius:8px;margin-bottom:15px}
input,select,button{width:100%;padding:10px;margin:5px 0;font-size:14px}
button{background:var(--main);color:#fff;border:none;border-radius:5px;cursor:pointer}
.filters,.stats{display:flex;gap:5px;flex-wrap:wrap}
.filters button,.stats div{flex:1}
.stats div{background:#eef3fa;padding:10px;border-radius:6px;text-align:center}
table{width:100%;border-collapse:collapse;min-width:1200px}
th,td{border:1px solid #ccc;padding:6px;text-align:center;font-size:13px}
th{background:var(--main);color:#fff}
.warn{background:var(--warn)}
.danger{background:var(--danger)}
.unpaid{background:var(--unpaid)}
.actions button{padding:5px 8px;margin:2px}
.days-box{padding:4px 8px;border-radius:12px;font-weight:bold}
.days-ok{background:#e8f5e9;color:#2e7d32}
.days-warn{background:#fff3e0;color:#ef6c00}
.days-expired{background:#fdecea;color:#c62828}
.alert-btn{background:#ef6c00;margin-bottom:10px}
</style>
</head>

<body>

<h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h2>

<input id="search" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ù‡Ø§ØªÙ / Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" onkeyup="render()">

<div class="filters">
 <button onclick="setFilter('all')">Ø§Ù„ÙƒÙ„</button>
 <button onclick="setFilter('active')">Ù†Ø´Ø·</button>
 <button onclick="setFilter('expired')">Ù…Ù†ØªÙ‡ÙŠ</button>
 <button onclick="setFilter('unpaid')">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</button>
</div>

<div class="card stats">
 <div>ğŸ“¦ Ø§Ù„ÙƒÙ„<br><b id="stTotal">0</b></div>
 <div>ğŸŸ¢ Ù†Ø´Ø·<br><b id="stActive">0</b></div>
 <div>ğŸ”´ Ù…Ù†ØªÙ‡ÙŠ<br><b id="stExpired">0</b></div>
 <div>âŒ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹<br><b id="stUnpaid">0</b></div>
</div>

<button class="alert-btn" onclick="sendTodayAlerts()">
ğŸ“© Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø©
</button>

<div class="card">
 <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†">
 <input id="phone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ">
 <input id="email" placeholder="Email">
 <input id="profile" placeholder="Profil (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
 <select id="product">
  <option value="">Ø§Ù„Ù…Ù†ØªØ¬</option>
  <option>Netflix</option>
  <option>Shahid</option>
  <option>IPTV</option>
 </select>
 <input id="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±">
 <input id="days" type="number" placeholder="Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ">
 <button onclick="addSub()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ</button>
</div>

<div class="card">
<table>
<thead>
<tr>
 <th>Ø§Ù„Ø§Ø³Ù…</th>
 <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
 <th>Email</th>
 <th>Profil</th>
 <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
 <th>Ø§Ù„Ø³Ø¹Ø±</th>
 <th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
 <th>â³ Ø§Ù„Ø£ÙŠØ§Ù…</th>
 <th>Ù…Ø¯ÙÙˆØ¹</th>
 <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
 getFirestore, collection, addDoc, getDocs,
 updateDoc, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

/* Firebase config */
const firebaseConfig = {
 apiKey: "AIzaSyBTE_aaLCtUHt5MZq95k7uYCQ1vl7jTQvw",
 authDomain: "systeme-des-abonnements-6a98c.firebaseapp.com",
 projectId: "systeme-des-abonnements-6a98c",
 storageBucket: "systeme-des-abonnements-6a98c.appspot.com",
 messagingSenderId: "74948745712",
 appId: "1:74948745712:web:ea9140bdf7dafb85baa535"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const $ = id => document.getElementById(id);
let subs = [];
let currentFilter = "all";

/* ØªØ­Ù…ÙŠÙ„ */
async function loadSubs(){
 subs = [];
 const snap = await getDocs(collection(db,"subs"));
 snap.forEach(d => subs.push({ id:d.id, ...d.data() }));
 render();
}

/* ÙÙ„ØªØ±Ø© */
function setFilter(f){ currentFilter=f; render(); }

/* ØªØ§Ø±ÙŠØ® */
function fmt(d){
 return d.getFullYear()+"/"+String(d.getMonth()+1).padStart(2,"0")+"/"+String(d.getDate()).padStart(2,"0");
}

/* WhatsApp */
function sendWhatsApp(phone,name,product,end,days){
 let msg =
`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name} ğŸ‘‹

Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ Ø®Ø¯Ù…Ø© ${product}
Ø³ÙŠÙ†ØªÙ‡ÙŠ Ø¨ØªØ§Ø±ÙŠØ® ${end} â°
â³ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${days} Ø£ÙŠØ§Ù…

ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø£Ùˆ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯.
Ù†Ø­Ù† ÙÙŠ Ø®Ø¯Ù…ØªÙƒÙ… Ø¯Ø§Ø¦Ù…Ø§Ù‹ ğŸŒŸ`;

 window.open("https://wa.me/"+phone+"?text="+encodeURIComponent(msg),"_blank");
}

/* Ø¥Ø¶Ø§ÙØ© */
async function addSub(){
 let name=$("name").value.trim();
 let phone=$("phone").value.trim();
 let email=$("email").value.trim();
 let profile=$("profile").value.trim();
 let product=$("product").value;
 let price=$("price").value;
 let days=parseInt($("days").value,10);

 if(!name||!phone||!product||!days){
  alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©");
  return;
 }

 let start=new Date(); start.setHours(0,0,0,0);
 let end=new Date(start); end.setDate(end.getDate()+days);

 await addDoc(collection(db,"subs"),{
  name,phone,email,profile,product,price,
  end:end.toISOString(),
  paid:false
 });

 ["name","phone","email","profile","price","days"].forEach(i=>$(i).value="");
 $("product").value="";
 loadSubs();
}

/* âœï¸ ØªØ¹Ø¯ÙŠÙ„ */
async function editSub(id){
 let s=subs.find(x=>x.id===id);
 if(!s) return;

 let name=prompt("Ø§Ù„Ø§Ø³Ù…",s.name) ?? s.name;
 let phone=prompt("Ø§Ù„Ù‡Ø§ØªÙ",s.phone) ?? s.phone;
 let email=prompt("Email",s.email) ?? s.email;
 let profile=prompt("Profil",s.profile) ?? s.profile;
 let price=prompt("Ø§Ù„Ø³Ø¹Ø±",s.price) ?? s.price;

 await updateDoc(doc(db,"subs",id),{
  name,phone,email,profile,price
 });

 loadSubs();
}

/* ğŸ”„ ØªØ¬Ø¯ÙŠØ¯ (Ø£Ù†Øª ØªØ­Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…) */
async function renewSub(id){
 let s=subs.find(x=>x.id===id);
 if(!s) return;

 let d=parseInt(prompt("Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯"),10);
 if(!d||d<=0) return;

 let end=new Date(s.end);
 let today=new Date(); today.setHours(0,0,0,0);
 if(end<today) end=today;
 end.setDate(end.getDate()+d);

 await updateDoc(doc(db,"subs",id),{
  end:end.toISOString()
 });

 loadSubs();

 let diff=Math.floor((end-today)/86400000);
 sendWhatsApp(s.phone,s.name,s.product,fmt(end),diff);
}

/* Ù…Ø¯ÙÙˆØ¹ */
async function togglePaid(id,val){
 await updateDoc(doc(db,"subs",id),{paid:val});
 loadSubs();
}

/* ğŸ—‘ Ø­Ø°Ù */
async function deleteSub(id){
 if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ")) return;
 await deleteDoc(doc(db,"subs",id));
 loadSubs();
}

/* ğŸ”” ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
function sendTodayAlerts(){
 let today=new Date(); today.setHours(0,0,0,0);
 let found=false;

 subs.forEach(s=>{
  let end=new Date(s.end); end.setHours(0,0,0,0);
  let diff=Math.floor((end-today)/86400000);

  if(diff===3){
   sendWhatsApp(s.phone,s.name,s.product,fmt(end),diff);
   found=true;
  }
 });

 if(!found) alert("Ù…Ø§ ÙƒØ§Ø´ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù‚Ø±ÙŠØ¨Ø© ØªÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ 3 Ø£ÙŠØ§Ù…");
}

/* Ø¹Ø±Ø¶ */
function render(){
 $("list").innerHTML="";
 let today=new Date(); today.setHours(0,0,0,0);
 let q=$("search").value.toLowerCase();

 let t=0,a=0,e=0,u=0;

 subs.forEach(s=>{
  let end=new Date(s.end); end.setHours(0,0,0,0);
  let diff=Math.floor((end-today)/86400000);

  t++; diff<0?e++:a++; if(!s.paid)u++;

  if(currentFilter==="active" && diff<0) return;
  if(currentFilter==="expired" && diff>=0) return;
  if(currentFilter==="unpaid" && s.paid) return;
  if(q && !(`${s.name}${s.phone}${s.email}${s.profile}`.toLowerCase().includes(q))) return;

  let tr=document.createElement("tr");
  if(diff<0)tr.classList.add("danger");
  else if(diff<=3)tr.classList.add("warn");
  if(!s.paid)tr.classList.add("unpaid");

  tr.innerHTML=`
<td>${s.name}</td>
<td>${s.phone}</td>
<td>${s.email||"-"}</td>
<td>${s.profile||"-"}</td>
<td>${s.product}</td>
<td>${s.price||"-"}</td>
<td>${fmt(end)}</td>
<td><span class="days-box ${diff<0?'days-expired':diff<=3?'days-warn':'days-ok'}">${diff}</span></td>
<td><input type="checkbox" ${s.paid?"checked":""}
 onclick="togglePaid('${s.id}',this.checked)"></td>
<td class="actions">
 <button onclick="sendWhatsApp('${s.phone}','${s.name}','${s.product}','${fmt(end)}',${diff})">ğŸ’¬</button>
 <button onclick="editSub('${s.id}')">âœï¸</button>
 <button onclick="renewSub('${s.id}')">ğŸ”„</button>
 <button onclick="deleteSub('${s.id}')">ğŸ—‘</button>
</td>`;
  $("list").appendChild(tr);
 });

 $("stTotal").textContent=t;
 $("stActive").textContent=a;
 $("stExpired").textContent=e;
 $("stUnpaid").textContent=u;
}

/* Ø±Ø¨Ø· */
Object.assign(window,{
 addSub,editSub,renewSub,deleteSub,
 togglePaid,setFilter,sendWhatsApp,sendTodayAlerts
});

loadSubs();
</script>

</body>
</html>
