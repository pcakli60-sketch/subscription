<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</title>

<style>
:root{
 --main:#1976d2;
 --success:#2e7d32;
 --warning:#ef6c00;
 --danger:#c62828;
 --bg:#f4f6f9;
 --card:#ffffff;
 --unpaid:#fdecea;
}
body{font-family:Arial;background:var(--bg);margin:0;padding:15px}
h2{text-align:center;color:var(--main)}

.card{
 background:var(--card);
 padding:15px;
 border-radius:10px;
 margin-bottom:15px;
 box-shadow:0 2px 6px rgba(0,0,0,.05)
}
input,select,button{
 width:100%;
 padding:10px;
 margin:5px 0;
 font-size:14px
}
button{
 border:none;border-radius:6px;cursor:pointer;color:#fff
}
.main{background:var(--main)}
.success{background:var(--success)}
.warning{background:var(--warning)}
.danger{background:var(--danger)}

.filters,.stats{display:flex;gap:5px;flex-wrap:wrap}
.filters button,.stats div{flex:1}
.stats div{
 background:#eef3fa;padding:10px;border-radius:8px;
 text-align:center;font-weight:bold
}

table{width:100%;border-collapse:collapse;min-width:1200px}
th,td{border:1px solid #ddd;padding:6px;text-align:center;font-size:13px}
th{background:var(--main);color:#fff}

.row-ok{background:#e8f5e9}
.row-warn{background:#fff3e0}
.row-expired{background:#fdecea}
.row-unpaid{background:var(--unpaid)}

.days-box{padding:4px 8px;border-radius:12px;font-weight:bold}
.days-ok{background:#c8e6c9;color:var(--success)}
.days-warn{background:#ffe0b2;color:var(--warning)}
.days-expired{background:#ffcdd2;color:var(--danger)}

.actions button{padding:5px 8px;margin:2px;font-size:13px}
.logout{background:var(--danger);width:auto;padding:6px 12px}
.alert-btn{background:var(--warning);margin-bottom:10px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox" class="card" style="max-width:380px;margin:120px auto;text-align:center">
 <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
 <input id="loginEmail" type="email" placeholder="E-mail">
 <input id="loginPass" type="password" placeholder="Mot de passe">
 <button class="main" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
</div>

<!-- APP -->
<div id="app" style="display:none">

<div style="display:flex;justify-content:space-between;align-items:center">
 <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</h2>
 <button class="logout" onclick="logout()">Logout</button>
</div>

<input id="search"
 placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ù‡Ø§ØªÙ / Email / Profil"
 onkeyup="onSearch(this.value)">

<div class="filters">
 <button class="main" onclick="setFilter('all')">Ø§Ù„ÙƒÙ„</button>
 <button class="success" onclick="setFilter('active')">Ù†Ø´Ø·</button>
 <button class="danger" onclick="setFilter('expired')">Ù…Ù†ØªÙ‡ÙŠ</button>
 <button class="warning" onclick="setFilter('unpaid')">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</button>
</div>

<div class="card stats">
 <div>ğŸ“¦ Ø§Ù„ÙƒÙ„<br><span id="stTotal">0</span></div>
 <div style="color:var(--success)">ğŸŸ¢ Ù†Ø´Ø·<br><span id="stActive">0</span></div>
 <div style="color:var(--danger)">ğŸ”´ Ù…Ù†ØªÙ‡ÙŠ<br><span id="stExpired">0</span></div>
 <div style="color:var(--warning)">âŒ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹<br><span id="stUnpaid">0</span></div>
</div>

<button class="alert-btn" onclick="sendAlerts()">ğŸ”” Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</button>

<div class="card">
 <input id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†">
 <input id="phone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 213xxxxxxxxx)">
 <input id="email" placeholder="Email">
 <input id="profile" placeholder="Profil">
 <select id="product">
  <option value="">Ø§Ù„Ø®Ø¯Ù…Ø©</option>
  <option>Netflix</option>
  <option>Shahid</option>
  <option>IPTV</option>
 </select>
 <input id="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±">
 <input id="days" type="number" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…">
 <button class="main" onclick="addSub()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ø´ØªØ±Ø§Ùƒ</button>
</div>

<div class="card">
<table>
<thead>
<tr>
 <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Email</th><th>Profil</th>
 <th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
 <th>â³ Ø§Ù„Ø£ÙŠØ§Ù…</th><th>Ù…Ø¯ÙÙˆØ¹</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc }
from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";
import {
 getAuth, signInWithEmailAndPassword, signOut,
 onAuthStateChanged, setPersistence, browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

/* Firebase */
const firebaseConfig = {
 apiKey: "AIzaSyBTE_aaLCtUHt5MZq95k7uYCQ1vl7jTQvw",
 authDomain: "systeme-des-abonnements-6a98c.firebaseapp.com",
 projectId: "systeme-des-abonnements-6a98c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
setPersistence(auth, browserLocalPersistence);

const $ = id => document.getElementById(id);
let subs=[], currentFilter="all", searchText="";

/* AUTH */
async function login(){
 await signInWithEmailAndPassword(auth,$("loginEmail").value,$("loginPass").value);
}
async function logout(){ await signOut(auth); }

onAuthStateChanged(auth,user=>{
 $("loginBox").style.display=user?"none":"block";
 $("app").style.display=user?"block":"none";
 if(user) loadSubs();
});

/* LOAD */
async function loadSubs(){
 subs=[];
 const snap=await getDocs(collection(db,"subs"));
 snap.forEach(d=>subs.push({id:d.id,...d.data()}));
 render();
}

/* SEARCH */
function onSearch(val){
 searchText = val.toLowerCase();
 render();
}

/* DATE */
function calcDays(endISO){
 let end=new Date(endISO); end.setHours(0,0,0,0);
 let today=new Date(); today.setHours(0,0,0,0);
 let diff=Math.ceil((end-today)/86400000);
 if(end<today) diff=-1;
 return diff;
}
function fmt(d){
 return d.getFullYear()+"/"+String(d.getMonth()+1).padStart(2,"0")+"/"+String(d.getDate()).padStart(2,"0");
}

/* WhatsApp */
function sendWhatsApp(phone, name, product, end, days){
 if(!phone) return;

 product = product || "Ø§Ù„Ø®Ø¯Ù…Ø©";

 let msg = "";

 // ğŸ”´ Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ
 if(days < 0){
  msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name} ğŸ‘‹

âš ï¸ Ù‚Ø¯ Ø§Ù†ØªÙ‡Ù‰ Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ Ø®Ø¯Ù…Ø© ${product}
ğŸ“… Ø¨ØªØ§Ø±ÙŠØ®: ${end}

ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ù„ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ğŸ”„
Ù†Ø­Ù† ÙÙŠ Ø®Ø¯Ù…ØªÙƒÙ… Ø¯Ø§Ø¦Ù…Ø§Ù‹ ğŸŒŸ

â€” Yazid STORE`;
 }
 // ğŸŸ¢ Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø§Ø²Ø§Ù„ Ù†Ø´Ø·
 else{
  msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name} ğŸ‘‹

Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙÙŠ Ø®Ø¯Ù…Ø© ${product}
Ø³ÙŠÙ†ØªÙ‡ÙŠ Ø¨ØªØ§Ø±ÙŠØ® ${end} â°
â³ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${days} Ø£ÙŠØ§Ù…

ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø£Ùˆ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯.
Ù†Ø­Ù† ÙÙŠ Ø®Ø¯Ù…ØªÙƒÙ… Ø¯Ø§Ø¦Ù…Ø§Ù‹ ğŸŒŸ

â€” Yazid STORE`;
 }

 window.open(
  "https://wa.me/" + phone + "?text=" + encodeURIComponent(msg),
  "_blank"
 );
}

/* CRUD */
async function addSub(){
 let days=parseInt($("days").value,10);
 if(!days||!$("name").value||!$("phone").value||!$("product").value)return;

 let end=new Date(); end.setHours(0,0,0,0); end.setDate(end.getDate()+days);

 await addDoc(collection(db,"subs"),{
  name:$("name").value,
  phone:$("phone").value,
  email:$("email").value,
  profile:$("profile").value,
  product:$("product").value,
  price:$("price").value,
  end:end.toISOString(),
  paid:false,
  alert3Sent:false,
  alertExpiredSent:false
 });
 await loadSubs();
 ["name","phone","email","profile","product","price","days"].forEach(i=>$(i).value="");
}

async function editSub(id){
 let s=subs.find(x=>x.id===id);
 await updateDoc(doc(db,"subs",id),{
  name:prompt("Ø§Ù„Ø§Ø³Ù…",s.name)||s.name,
  phone:prompt("Ø§Ù„Ù‡Ø§ØªÙ",s.phone)||s.phone,
  email:prompt("Email",s.email)||s.email,
  profile:prompt("Profil",s.profile)||s.profile,
  product:prompt("Ø§Ù„Ø®Ø¯Ù…Ø©",s.product)||s.product,
  price:prompt("Ø§Ù„Ø³Ø¹Ø±",s.price)||s.price
 });
 await loadSubs();
}

async function renewSub(id){
 let s=subs.find(x=>x.id===id);
 let d=parseInt(prompt("Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯"),10);
 if(!d)return;
 let end=new Date(s.end); end.setDate(end.getDate()+d);
 await updateDoc(doc(db,"subs",id),{
  end:end.toISOString(),
  alert3Sent:false,
  alertExpiredSent:false
 });
 await loadSubs();
}

async function deleteSub(id){
 if(confirm("Ø­Ø°Ù Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŸ")){
  await deleteDoc(doc(db,"subs",id));
  await loadSubs();
 }
}

async function togglePaid(id,val){
 await updateDoc(doc(db,"subs",id),{paid:val});
 await loadSubs();
}

/* ALERTS */
async function sendAlerts(){
 for(let s of subs){
  let diff=calcDays(s.end);
  if(diff===3 && !s.alert3Sent){
   sendWhatsApp(s.phone,s.name,s.product,fmt(new Date(s.end)),diff);
   await updateDoc(doc(db,"subs",s.id),{alert3Sent:true});
   break;
  }
  if(diff<0 && !s.alertExpiredSent){
   sendWhatsApp(s.phone,s.name,s.product,fmt(new Date(s.end)),diff);
   await updateDoc(doc(db,"subs",s.id),{alertExpiredSent:true});
   break;
  }
 }
}

/* FILTER + RENDER */
function setFilter(f){currentFilter=f;render();}

function render(){
 $("list").innerHTML="";
 let t=0,a=0,e=0,u=0;

 subs.forEach(s=>{
  let diff=calcDays(s.end);
  t++; diff<0?e++:a++; if(!s.paid)u++;

  if(currentFilter==="active"&&diff<0)return;
  if(currentFilter==="expired"&&diff>=0)return;
  if(currentFilter==="unpaid"&&s.paid)return;
  if(searchText && !(`${s.name}${s.phone}${s.email}${s.profile}`.toLowerCase().includes(searchText)))return;

  let tr=document.createElement("tr");
  if(!s.paid) tr.className="row-unpaid";
  else if(diff<0) tr.className="row-expired";
  else if(diff<=3) tr.className="row-warn";
  else tr.className="row-ok";

  tr.innerHTML=`
<td>${s.name}</td><td>${s.phone}</td><td>${s.email||"-"}</td>
<td>${s.profile||"-"}</td><td>${s.product}</td><td>${s.price||"-"}</td>
<td>${fmt(new Date(s.end))}</td>
<td><span class="days-box ${diff<0?'days-expired':diff<=3?'days-warn':'days-ok'}">${diff}</span></td>
<td><input type="checkbox" ${s.paid?"checked":""} onclick="togglePaid('${s.id}',this.checked)"></td>
<td class="actions">
 <button class="success" onclick="sendWhatsApp('${s.phone}','${s.name}','${s.product}','${fmt(new Date(s.end))}',${diff})">ğŸ’¬</button>
 <button class="main" onclick="editSub('${s.id}')">âœï¸</button>
 <button class="warning" onclick="renewSub('${s.id}')">ğŸ”„</button>
 <button class="danger" onclick="deleteSub('${s.id}')">ğŸ—‘</button>
</td>`;
  $("list").appendChild(tr);
 });

 $("stTotal").textContent=t;
 $("stActive").textContent=a;
 $("stExpired").textContent=e;
 $("stUnpaid").textContent=u;
}

Object.assign(window,{
 login,logout,addSub,editSub,renewSub,
 deleteSub,togglePaid,setFilter,onSearch,
 sendWhatsApp,sendAlerts
});
</script>

</body>
</html>
